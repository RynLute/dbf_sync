# README.md

## üìò DBF Sync Refactor

**DBF Sync Refactor** ‚Äî —ç—Ç–æ —É—Ç–∏–ª–∏—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ DBF-—Ñ–∞–π–ª–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (SQLite –∏–ª–∏ PostgreSQL). –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ *–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (time series)*: –ø–æ–ª—è `DATE` –∏ `TIME` –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ –ø–æ–ª–µ `TS`.

### üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á—Ç–µ–Ω–∏—è DBF-—Ñ–∞–π–ª–æ–≤ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Å—á—ë—Ç—á–∏–∫–∞ (`COUNTER_ID`) –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
- –ü–∞–∫–µ—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (batch insert) –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SQLite –∏ PostgreSQL.
- –í–µ–¥–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`state.json`).
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å dry-run (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ë–î).
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (`--init`).
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤.

---

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install pyyaml dbfread psycopg2-binary tqdm
```

### 2Ô∏è‚É£ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `config.yaml` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```yaml
source:
  folder: ./dbf            # –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å DBF —Ñ–∞–π–ª–∞–º–∏
  pattern: ????xxxx.dbf     # —à–∞–±–ª–æ–Ω –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤, xxxx –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –≥–æ–¥

db:
  type: sqlite             # –∏–ª–∏ 'postgres'
  sqlite_path: ./db.sqlite  # –ø—É—Ç—å –∫ sqlite –±–∞–∑–µ
  # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PostgreSQL (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
  # host: 127.0.0.1
  # port: 5432
  # dbname: reports
  # user: postgres
  # password: secret

state_file: ./state.json   # —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
log_file: ./dbf_sync.log   # —Ñ–∞–π–ª –ª–æ–≥–æ–≤
batch_size: 1000           # —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –≤—Å—Ç–∞–≤–∫–∏
```

---

## üß© –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
python dbf_sync_refactor.py --init --config config.yaml
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```bash
python dbf_sync_refactor.py --config config.yaml
```

### Dry-run (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ë–î)
```bash
python dbf_sync_refactor.py --config config.yaml --dry-run
```

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `reports`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER / SERIAL | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| counter_id | INTEGER | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—á—ë—Ç—á–∏–∫–∞ |
| ts | TIMESTAMP / TEXT | –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏) |
| count | INTEGER | –ó–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ |
| kod | INTEGER | –ö–æ–¥ —Å–æ–±—ã—Ç–∏—è |
| key | INTEGER | –ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä |
| avr, dna, pit, ktime | BOOLEAN / INTEGER | –ë—É–ª–µ–≤—ã —Ñ–ª–∞–≥–∏ |
| avrtime, pittime | INTEGER | –í—Ä–µ–º—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π |
| fs | INTEGER | –ö–æ–¥ —Ñ–ª–∞–≥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| shift | INTEGER | –ù–æ–º–µ—Ä —Å–º–µ–Ω—ã |
| shift_end | BOOLEAN | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–º–µ–Ω—ã |
| sensor1_alarm, sensor2_alarm | BOOLEAN | –ê–≤–∞—Ä–∏–∏ –¥–∞—Ç—á–∏–∫–æ–≤ |
| time_sync | BOOLEAN | –§–ª–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ |
| read_attempt | BOOLEAN | –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è |

---

## üìÑ –õ–æ–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∏ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª `dbf_sync.log` (—Ä–æ—Ç–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞).
- –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `state.json`.

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã

```bash
# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –¥–ª—è SQLite
env PYTHONUTF8=1 python dbf_sync_refactor.py --config config.yaml

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –¥–ª—è PostgreSQL
python dbf_sync_refactor.py --config config_pg.yaml
```

---

## üß∞ –õ–∏—Ü–µ–Ω–∑–∏—è
MIT License